<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê∆°n ngh·ªâ ph√©p n√¢ng cao</title>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <style>
    body { font-family: Arial; max-width: 750px; margin: 40px auto; padding: 20px; }
    label { display: block; margin-top: 14px; }
    input, select, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px 20px; }
    h2 { text-align: center; }
  </style>
</head>
<body>
  <h2>ƒê∆°n xin ngh·ªâ ph√©p n√¢ng cao</h2>
  <form id="leave-form">
    <label>B·ªô ph·∫≠n:</label>
    <select id="department" required>
      <option value="">-- Ch·ªçn b·ªô ph·∫≠n --</option>
    </select>

    <label>V·ªã tr√≠:</label>
    <select id="position" required>
      <option value="">-- Ch·ªçn v·ªã tr√≠ --</option>
    </select>

    <label>Ng∆∞·ªùi l√†m ƒë∆°n:</label>
    <select id="employee" required>
      <option value="">-- Ch·ªçn nh√¢n s·ª± --</option>
    </select>

    <label>Email ng∆∞·ªùi l√†m ƒë∆°n:</label>
    <input type="email" id="email" readonly>

    <label>Ca ngh·ªâ:</label>
<select id="shift" required>
  <option value="">-- Ch·ªçn ca ngh·ªâ --</option>
  <option value="S√°ng">S√°ng</option>
  <option value="Chi·ªÅu">Chi·ªÅu</option>
  <option value="C·∫£ ng√†y">C·∫£ ng√†y</option>
</select>

    <label>Ng√†y b·∫Øt ƒë·∫ßu:</label>
    <input type="date" id="startDate" required>

    <label>Ng√†y k·∫øt th√∫c:</label>
    <input type="date" id="endDate" required>

    <label>S·ªë ng√†y ngh·ªâ:</label>
    <input type="number" id="daysOff" step="0.5" min="0.5" required>

    <label>Ngh·ªâ ph√©p d∆∞·ªõi d·∫°ng:</label>
<select id="leaveType" required>
  <option value="">-- Ch·ªçn lo·∫°i ngh·ªâ --</option>
  <option value="D√πng ph√©p">D√πng ph√©p</option>
  <option value="Kh√¥ng l∆∞∆°ng">Kh√¥ng l∆∞∆°ng</option>
</select>


    <label>L√Ω do ngh·ªâ:</label>
    <textarea id="reason" required></textarea>

    <label>C√¥ng vi·ªác ƒëang ƒë·∫£m nh·∫≠n:</label>
    <textarea id="currentWork" required></textarea>

    <label>C√¥ng vi·ªác c√≥ th·ªÉ l√†m t·ª´ xa:</label>
    <textarea id="remoteWork" required></textarea>

    <label>Ng∆∞·ªùi nh·∫≠n b√†n giao:</label>
    <select id="handoverTo" required>
      <option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option>
    </select>

    <label>V·ªã tr√≠ ng∆∞·ªùi nh·∫≠n b√†n giao:</label>
    <input type="text" id="handoverPosition" readonly>

    <label>Email ng∆∞·ªùi nh·∫≠n b√†n giao:</label>
    <input type="email" id="handoverEmail" readonly>

    <button type="submit">G·ª≠i ƒë∆°n ngh·ªâ ph√©p</button>
  </form>

  <script>
    const data = [
      { "T√™n nh√¢n s·ª±": "Nguy·ªÖn VƒÉn A", "B·ªô ph·∫≠n": "K·∫ø to√°n", "V·ªã tr√≠": "Nh√¢n vi√™n", "Email nh√¢n s·ª±": "a@company.com" },
      { "T√™n nh√¢n s·ª±": "Tr·∫ßn Th·ªã B", "B·ªô ph·∫≠n": "K·∫ø to√°n", "V·ªã tr√≠": "Tr∆∞·ªüng ph√≤ng", "Email nh√¢n s·ª±": "b@company.com" },
      { "T√™n nh√¢n s·ª±": "L√™ VƒÉn C", "B·ªô ph·∫≠n": "IT", "V·ªã tr√≠": "Developer", "Email nh√¢n s·ª±": "c@company.com" },
      { "T√™n nh√¢n s·ª±": "Ph·∫°m Th·ªã D", "B·ªô ph·∫≠n": "IT", "V·ªã tr√≠": "Tester", "Email nh√¢n s·ª±": "d@company.com" },
      { "T√™n nh√¢n s·ª±": "Ho√†ng VƒÉn E", "B·ªô ph·∫≠n": "K·∫ø to√°n", "V·ªã tr√≠": "Nh√¢n vi√™n", "Email nh√¢n s·ª±": "e@company.com" }
    ];

    const department = document.getElementById("department");
    const position = document.getElementById("position");
    const employee = document.getElementById("employee");
    const email = document.getElementById("email");
    const handoverTo = document.getElementById("handoverTo");
    const handoverPosition = document.getElementById("handoverPosition");
    const handoverEmail = document.getElementById("handoverEmail");

    let positionSelectInstance, employeeSelectInstance;

    function initDepartment() {
      const departments = [...new Set(data.map(d => d["B·ªô ph·∫≠n"]))];
      departments.forEach(dept => {
        const opt = document.createElement("option");
        opt.value = dept;
        opt.textContent = dept;
        department.appendChild(opt);
      });
      new TomSelect("#department", { create: false, sortField: "text" });
    }

    function updatePositions() {
      const dept = department.value;
      if (!dept) return;

      if (positionSelectInstance) positionSelectInstance.destroy();
      position.innerHTML = '<option value="">-- Ch·ªçn v·ªã tr√≠ --</option>';

      const positions = [...new Set(data.filter(d => d["B·ªô ph·∫≠n"] === dept).map(d => d["V·ªã tr√≠"]))];
      positions.forEach(pos => {
        const opt = document.createElement("option");
        opt.value = pos;
        opt.textContent = pos;
        position.appendChild(opt);
      });

      positionSelectInstance = new TomSelect("#position", { create: false, sortField: "text" });

      if (employeeSelectInstance) employeeSelectInstance.destroy();
      employee.innerHTML = '<option value="">-- Ch·ªçn nh√¢n s·ª± --</option>';

      department.blur(); // üëà M·∫•t focus kh·ªèi b·ªô ph·∫≠n sau khi ch·ªçn
    }

    function updateEmployees() {
      const dept = department.value;
      const pos = position.value;
      if (!dept || !pos) return;

      if (employeeSelectInstance) employeeSelectInstance.destroy();
      employee.innerHTML = '<option value="">-- Ch·ªçn nh√¢n s·ª± --</option>';

      const employees = data.filter(d => d["B·ªô ph·∫≠n"] === dept && d["V·ªã tr√≠"] === pos);
      employees.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e["T√™n nh√¢n s·ª±"];
        opt.textContent = e["T√™n nh√¢n s·ª±"];
        employee.appendChild(opt);
      });

      employeeSelectInstance = new TomSelect("#employee", { create: false, sortField: "text" });

      position.blur(); // üëà M·∫•t focus kh·ªèi v·ªã tr√≠ sau khi ch·ªçn
    }

    function fillEmailFromName(name, isHandover = false) {
      const user = data.find(d => d["T√™n nh√¢n s·ª±"] === name);
      if (!user) return;
      if (isHandover) {
        handoverPosition.value = user["V·ªã tr√≠"];
        handoverEmail.value = user["Email nh√¢n s·ª±"];
        handoverTo.blur(); // üëà M·∫•t focus sau khi ch·ªçn ng∆∞·ªùi b√†n giao
      } else {
        email.value = user["Email nh√¢n s·ª±"];
        employee.blur(); // üëà M·∫•t focus sau khi ch·ªçn ng∆∞·ªùi l√†m ƒë∆°n
      }
    }

    function populateHandoverDropdown() {
      data.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e["T√™n nh√¢n s·ª±"];
        opt.textContent = e["T√™n nh√¢n s·ª±"];
        handoverTo.appendChild(opt);
      });
      new TomSelect("#handoverTo", { create: false, sortField: "text" });
    }

    department.addEventListener("change", updatePositions);
    position.addEventListener("change", updateEmployees);
    employee.addEventListener("change", () => fillEmailFromName(employee.value));
    handoverTo.addEventListener("change", () => fillEmailFromName(handoverTo.value, true));

    document.getElementById("leave-form").addEventListener("submit", e => {
      e.preventDefault();

      const payload = {
        department: department.value,
        position: position.value,
        employeeName: employee.value,
        email: email.value,
        shift: document.getElementById("shift").value,
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        daysOff: document.getElementById("daysOff").value,
        leaveType: document.getElementById("leaveType").value,
        reason: document.getElementById("reason").value,
        currentWork: document.getElementById("currentWork").value,
        remoteWork: document.getElementById("remoteWork").value,
        handoverTo: handoverTo.value,
        handoverPosition: handoverPosition.value,
        handoverEmail: handoverEmail.value
      };

      fetch("https://automation.starglobal3d.cloud/webhook-test/30f79f13-a545-4821-acd3-bb78d17f6aa7", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(res => {
        if (res.ok) alert("G·ª≠i ƒë∆°n th√†nh c√¥ng!");
        else alert("C√≥ l·ªói khi g·ª≠i ƒë∆°n.");
      });
    });

    initDepartment();
    populateHandoverDropdown();
  </script>
</body>
</html>

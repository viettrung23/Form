<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ĐƠN NGHỈ PHÉP</title>
  <style>
    body { font-family: Arial; max-width: 750px; margin: 40px auto; padding: 20px; }
    label { display: block; margin-top: 14px; }
    input, select, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px 20px; }
    h2 { text-align: center; }
  </style>
</head>
<body>
  <h2>ĐƠN NGHỈ PHÉP</h2>
  <form id="leave-form">
    <label>Bộ phận:</label>
    <select id="department" required>
      <option value="">-- Chọn bộ phận --</option>
    </select>

    <label>Vị trí:</label>
    <select id="position" required>
      <option value="">-- Chọn vị trí --</option>
    </select>

    <label>Người làm đơn:</label>
    <input list="employeeList" id="employee" required>
    <datalist id="employeeList"></datalist>

    <label>Email người làm đơn:</label>
    <input type="email" id="email">

    <label>Ca nghỉ:</label>
    <select id="shift" required>
      <option value="">-- Chọn ca nghỉ --</option>
      <option value="Sáng">Sáng</option>
      <option value="Chiều">Chiều</option>
      <option value="Cả ngày">Cả ngày</option>
    </select>

    <label>Ngày bắt đầu:</label>
    <input type="date" id="startDate" required>

    <label>Ngày kết thúc:</label>
    <input type="date" id="endDate" required>

    <label>Số ngày nghỉ:</label>
    <input type="number" id="daysOff" step="0.5" min="0.5" required>

    <label>Nghỉ phép dưới dạng:</label>
    <select id="leaveType" required>
      <option value="">-- Chọn loại nghỉ --</option>
      <option value="Dùng phép">Dùng phép</option>
      <option value="Không lương">Không lương</option>
    </select>

    <label>Lý do nghỉ:</label>
    <textarea id="reason" required></textarea>

    <label>Công việc đang đảm nhận:</label>
    <textarea id="currentWork" required></textarea>

    <label>Công việc có thể làm từ xa:</label>
    <textarea id="remoteWork" required></textarea>

    <label>Người nhận bàn giao:</label>
    <input list="handoverList" id="handoverTo" required>
    <datalist id="handoverList"></datalist>

    <label>Vị trí người nhận bàn giao:</label>
    <input type="text" id="handoverPosition">

    <label>Email người nhận bàn giao:</label>
    <input type="email" id="handoverEmail">

    <button type="submit">Gửi đơn nghỉ phép</button>
  </form>

  <script>
    let data = [];

    async function fetchDataAndInit() {
      try {
        const res = await fetch('https://automation.starglobal3d.cloud/webhook/72344435-89bd-4173-8415-fc1c3e609354');
        data = await res.json();
        initDropdowns();
      } catch (err) {
        alert("Không lấy được danh sách nhân sự từ hệ thống.");
      }
    }

    function initDropdowns() {
      const departments = [...new Set(data.map(d => d["BỘ PHẬN"]))];
      const positions = [...new Set(data.map(d => d["VỊ TRÍ"]))];
      const names = [...new Set(data.map(d => d["HỌ VÀ TÊN"]))];

      const dept = document.getElementById("department");
      const pos = document.getElementById("position");
      const empList = document.getElementById("employeeList");
      const handoverList = document.getElementById("handoverList");

      departments.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        dept.appendChild(opt);
      });

      positions.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        pos.appendChild(opt);
      });

      empList.innerHTML = "";
      handoverList.innerHTML = "";
      names.forEach(val => {
        const opt1 = document.createElement("option");
        const opt2 = document.createElement("option");
        opt1.value = opt2.value = val;
        empList.appendChild(opt1);
        handoverList.appendChild(opt2);
      });
    }

    const dept = document.getElementById("department");
    const pos = document.getElementById("position");
    const emp = document.getElementById("employee");
    const email = document.getElementById("email");
    const handoverTo = document.getElementById("handoverTo");
    const handoverPosition = document.getElementById("handoverPosition");
    const handoverEmail = document.getElementById("handoverEmail");

    dept.addEventListener("change", () => {
      pos.value = "";
      emp.value = "";
      email.value = "";
    });

    pos.addEventListener("change", () => {
      emp.value = "";
      email.value = "";
      const selected = data.find(d => d["VỊ TRÍ"] === pos.value);
      if (selected) {
        dept.value = selected["BỘ PHẬN"];
      }
    });

    emp.addEventListener("input", () => {
      const selected = data.find(d => d["HỌ VÀ TÊN"] === emp.value);
      if (selected) {
        dept.value = selected["BỘ PHẬN"];
        pos.value = selected["VỊ TRÍ"];
        email.value = selected["EMAIL ALIAS"];
      }
    });

    handoverTo.addEventListener("input", () => {
      const selected = data.find(d => d["HỌ VÀ TÊN"] === handoverTo.value);
      if (selected) {
        handoverPosition.value = selected["VỊ TRÍ"] || "";
        if (selected["EMAIL ALIAS"]) handoverEmail.value = selected["EMAIL ALIAS"];
      }
    });

    document.getElementById("startDate").addEventListener("change", calculateDaysOff);
    document.getElementById("endDate").addEventListener("change", calculateDaysOff);

    function calculateDaysOff() {
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      if (!isNaN(start) && !isNaN(end) && end >= start) {
        const diff = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        document.getElementById("daysOff").value = diff;
      } else {
        document.getElementById("daysOff").value = "";
      }
    }

    document.getElementById("leave-form").addEventListener("submit", e => {
      e.preventDefault();
      const payload = {
        department: dept.value,
        position: pos.value,
        employeeName: emp.value,
        email: email.value,
        shift: document.getElementById("shift").value,
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        daysOff: document.getElementById("daysOff").value,
        leaveType: document.getElementById("leaveType").value,
        reason: document.getElementById("reason").value,
        currentWork: document.getElementById("currentWork").value,
        remoteWork: document.getElementById("remoteWork").value,
        handoverTo: handoverTo.value,
        handoverPosition: handoverPosition.value,
        handoverEmail: handoverEmail.value
      };

      fetch("https://automation.starglobal3d.cloud/webhook/0804d048-6bcc-4d3e-ad42-cdf4ec7ea6cc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(res => {
        if (res.ok) {
          alert("Đơn đã được gửi thành công!");
          setTimeout(() => window.location.reload(), 100);
        } else {
          alert("Đã xảy ra lỗi khi gửi đơn.");
        }
      }).catch(err => alert("Lỗi khi gửi đơn: " + err.message));
    });

    fetchDataAndInit();
  </script>
</body>
</html>
